---
layout: post
title: Kafka Streams suppress feature
categories: what-i-learned
tags: java kafka streams
---
Kafka Streams is a Java streaming framework, that tightly integrates with Apacha Kafka. In contrast to Apache Spark of Apache Flink it does not require a separate cluster runtime. Instead it consist of a Java library to be fully integrated into any Java application. In that way it can augment the capabilities of that application by adding stream processing of Kafka topics. For a full feature  description of Kafka Streams check out the documentation on the Apache project page or from Confluent.

Kafka Streams provides its own DSL to describe the stream processing topology. It is build upon two primitives: KStream and KTable. KStream is an abstraction of one or more Kafka topics. It supports message processing one message at a time. Aggregating multiple messages yields a KTable. KTables can be transformed back to a KStream consisting of the changelog of the KTable. The official Kafka Streams documentation contains a nice description of this stream-table-duality.

Generating the changlog out of a KTable will generate at least one message for each aggregated message in the resulting KStream. Therefore, downstream processors will see as many messages as were contained in the original KStream. For some applications, it would be benefitial to have a downsampling of the message frequency at the cost of accuracy or latency. This is, what the suppress feature of Kafka Streams provides. It allows to _suppress_ messages on the changelog stream according to configurable conditions.

To understand the availbable suppressions, it is necessary to know the aggregations Kafka Streams supports. Messages will always be aggregated by their respective Kafka message key. This aggregation can be unbound or windowed. Kafka Streams supports different kinds of time windows and also a notion of session windows. A detailed description of windowed aggregations is contained in the official documentation.

Building on these aggregations, there are two modes of suppression, that are supported by Kafka Streams. All KTables support a time window suppression. That means changelog messages are only forwarded downstream after a certain duration has passed after the first change to the KTable was made. This requires a buffer, whose size can be configured in bytes or number of messages. If the buffer is exceeded before the duration is reached, the changelog will be emitted regardless. The other mode is only supported for windowed aggregations. In this case all changelog messages can be suppressed until the window is closed. For time windowed aggregations, it is required to configure a grace period, to allow for late messages. It can be set to 0, but it needs to be explicitly set, otherwise no message will be forwarded. Since the closing the window can occur well after any buffer size is exceeded, no messages will be forwarded if this limit is reached. Instead Kafka Streams will try to shutdown the application.
